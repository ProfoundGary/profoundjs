{"version":3,"file":"archive.js","names":["archiver","fs","Archive","outputPath","_classCallCheck","output","createWriteStream","archive","promise","Promise","resolve","reject","on","size","pointer","error","code","console","warn","pipe","_createClass","key","value","file","filePath","internalPath","name","directory","directoryPath","append","content","write","finalize","default"],"sources":["../../source/write/archive.js"],"sourcesContent":["// Copy-pasted from:\r\n// https://github.com/catamphetamine/serverless-functions/blob/master/source/deploy/archive.js\r\n\r\n// Uses `archiver` library.\r\n// https://www.npmjs.com/package/archiver\r\n\r\nimport archiver from 'archiver'\r\n// import { WritableStream } from 'memory-streams'\r\nimport fs from 'fs'\r\n\r\n/**\r\n * A server-side *.zip archive creator.\r\n */\r\nexport default class Archive {\r\n  constructor(outputPath) {\r\n    let output\r\n    if (outputPath) {\r\n      output = fs.createWriteStream(outputPath)\r\n    } else {\r\n      // // Won't work for memory streams.\r\n      // // https://github.com/archiverjs/node-archiver/issues/336\r\n      // output = new WritableStream()\r\n    }\r\n\r\n    const archive = archiver('zip', {\r\n      // // Sets the compression level.\r\n      // zlib: { level: 9 }\r\n    })\r\n\r\n    this.archive = archive\r\n\r\n    if (output) {\r\n      this.promise = new Promise((resolve, reject) => {\r\n        // listen for all archive data to be written\r\n        // 'close' event is fired only when a file descriptor is involved\r\n        output.on('close', () => resolve({ size: archive.pointer() }))\r\n\r\n        // // This event is fired when the data source is drained no matter what was the data source.\r\n        // // It is not part of this library but rather from the NodeJS Stream API.\r\n        // // @see: https://nodejs.org/api/stream.html#stream_event_end\r\n        // archive.on('end', function() {\r\n        //   console.log('Data has been drained')\r\n        //   resolve({\r\n        //     // output: outputPath ? undefined : output.toBuffer(),\r\n        //     size: archive.pointer()\r\n        //   })\r\n        // })\r\n\r\n        // good practice to catch warnings (ie stat failures and other non-blocking errors)\r\n        archive.on('warning', function(error) {\r\n          if (error.code === 'ENOENT') {\r\n            // log warning\r\n            console.warn(error)\r\n          } else {\r\n            reject(error)\r\n          }\r\n        })\r\n\r\n        // good practice to catch this error explicitly\r\n        archive.on('error', reject)\r\n\r\n        // pipe archive data to the file\r\n        archive.pipe(output)\r\n      })\r\n    }\r\n  }\r\n\r\n  file(filePath, internalPath) {\r\n    this.archive.file(filePath, { name: internalPath })\r\n  }\r\n\r\n  directory(directoryPath, internalPath) {\r\n    this.archive.directory(directoryPath, internalPath);\r\n  }\r\n\r\n  append(content, internalPath) {\r\n    this.archive.append(content, { name: internalPath })\r\n  }\r\n\r\n  write() {\r\n    // Maybe `.finalize()` itself returns some `Promise`.\r\n    this.archive.finalize()\r\n    return this.promise || this.archive\r\n  }\r\n}\r\n"],"mappings":";;;;;;AAAA;AACA;;AAEA;AACA;;AAEA,OAAOA,QAAQ,MAAM,UAAU;AAC/B;AACA,OAAOC,EAAE,MAAM,IAAI;;AAEnB;AACA;AACA;AAFA,IAGqBC,OAAO;EAC1B,SAAAA,QAAYC,UAAU,EAAE;IAAAC,eAAA,OAAAF,OAAA;IACtB,IAAIG,MAAM;IACV,IAAIF,UAAU,EAAE;MACdE,MAAM,GAAGJ,EAAE,CAACK,iBAAiB,CAACH,UAAU,CAAC;IAC3C,CAAC,MAAM;MACL;MACA;MACA;IAAA;IAGF,IAAMI,OAAO,GAAGP,QAAQ,CAAC,KAAK,EAAE;MAC9B;MACA;IAAA,CACD,CAAC;IAEF,IAAI,CAACO,OAAO,GAAGA,OAAO;IAEtB,IAAIF,MAAM,EAAE;MACV,IAAI,CAACG,OAAO,GAAG,IAAIC,OAAO,CAAC,UAACC,OAAO,EAAEC,MAAM,EAAK;QAC9C;QACA;QACAN,MAAM,CAACO,EAAE,CAAC,OAAO,EAAE;UAAA,OAAMF,OAAO,CAAC;YAAEG,IAAI,EAAEN,OAAO,CAACO,OAAO,CAAC;UAAE,CAAC,CAAC;QAAA,EAAC;;QAE9D;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;;QAEA;QACAP,OAAO,CAACK,EAAE,CAAC,SAAS,EAAE,UAASG,KAAK,EAAE;UACpC,IAAIA,KAAK,CAACC,IAAI,KAAK,QAAQ,EAAE;YAC3B;YACAC,OAAO,CAACC,IAAI,CAACH,KAAK,CAAC;UACrB,CAAC,MAAM;YACLJ,MAAM,CAACI,KAAK,CAAC;UACf;QACF,CAAC,CAAC;;QAEF;QACAR,OAAO,CAACK,EAAE,CAAC,OAAO,EAAED,MAAM,CAAC;;QAE3B;QACAJ,OAAO,CAACY,IAAI,CAACd,MAAM,CAAC;MACtB,CAAC,CAAC;IACJ;EACF;EAAC,OAAAe,YAAA,CAAAlB,OAAA;IAAAmB,GAAA;IAAAC,KAAA,EAED,SAAAC,IAAIA,CAACC,QAAQ,EAAEC,YAAY,EAAE;MAC3B,IAAI,CAAClB,OAAO,CAACgB,IAAI,CAACC,QAAQ,EAAE;QAAEE,IAAI,EAAED;MAAa,CAAC,CAAC;IACrD;EAAC;IAAAJ,GAAA;IAAAC,KAAA,EAED,SAAAK,SAASA,CAACC,aAAa,EAAEH,YAAY,EAAE;MACrC,IAAI,CAAClB,OAAO,CAACoB,SAAS,CAACC,aAAa,EAAEH,YAAY,CAAC;IACrD;EAAC;IAAAJ,GAAA;IAAAC,KAAA,EAED,SAAAO,MAAMA,CAACC,OAAO,EAAEL,YAAY,EAAE;MAC5B,IAAI,CAAClB,OAAO,CAACsB,MAAM,CAACC,OAAO,EAAE;QAAEJ,IAAI,EAAED;MAAa,CAAC,CAAC;IACtD;EAAC;IAAAJ,GAAA;IAAAC,KAAA,EAED,SAAAS,KAAKA,CAAA,EAAG;MACN;MACA,IAAI,CAACxB,OAAO,CAACyB,QAAQ,CAAC,CAAC;MACvB,OAAO,IAAI,CAACxB,OAAO,IAAI,IAAI,CAACD,OAAO;IACrC;EAAC;AAAA;AAAA,SAtEkBL,OAAO,IAAA+B,OAAA","ignoreList":[]}