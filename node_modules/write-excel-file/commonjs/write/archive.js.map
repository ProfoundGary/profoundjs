{"version":3,"file":"archive.js","names":["_archiver","_interopRequireDefault","require","_fs","e","__esModule","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","Archive","exports","outputPath","output","fs","createWriteStream","archive","archiver","promise","Promise","resolve","reject","on","size","pointer","error","code","console","warn","pipe","value","file","filePath","internalPath","name","directory","directoryPath","append","content","write","finalize"],"sources":["../../source/write/archive.js"],"sourcesContent":["// Copy-pasted from:\r\n// https://github.com/catamphetamine/serverless-functions/blob/master/source/deploy/archive.js\r\n\r\n// Uses `archiver` library.\r\n// https://www.npmjs.com/package/archiver\r\n\r\nimport archiver from 'archiver'\r\n// import { WritableStream } from 'memory-streams'\r\nimport fs from 'fs'\r\n\r\n/**\r\n * A server-side *.zip archive creator.\r\n */\r\nexport default class Archive {\r\n  constructor(outputPath) {\r\n    let output\r\n    if (outputPath) {\r\n      output = fs.createWriteStream(outputPath)\r\n    } else {\r\n      // // Won't work for memory streams.\r\n      // // https://github.com/archiverjs/node-archiver/issues/336\r\n      // output = new WritableStream()\r\n    }\r\n\r\n    const archive = archiver('zip', {\r\n      // // Sets the compression level.\r\n      // zlib: { level: 9 }\r\n    })\r\n\r\n    this.archive = archive\r\n\r\n    if (output) {\r\n      this.promise = new Promise((resolve, reject) => {\r\n        // listen for all archive data to be written\r\n        // 'close' event is fired only when a file descriptor is involved\r\n        output.on('close', () => resolve({ size: archive.pointer() }))\r\n\r\n        // // This event is fired when the data source is drained no matter what was the data source.\r\n        // // It is not part of this library but rather from the NodeJS Stream API.\r\n        // // @see: https://nodejs.org/api/stream.html#stream_event_end\r\n        // archive.on('end', function() {\r\n        //   console.log('Data has been drained')\r\n        //   resolve({\r\n        //     // output: outputPath ? undefined : output.toBuffer(),\r\n        //     size: archive.pointer()\r\n        //   })\r\n        // })\r\n\r\n        // good practice to catch warnings (ie stat failures and other non-blocking errors)\r\n        archive.on('warning', function(error) {\r\n          if (error.code === 'ENOENT') {\r\n            // log warning\r\n            console.warn(error)\r\n          } else {\r\n            reject(error)\r\n          }\r\n        })\r\n\r\n        // good practice to catch this error explicitly\r\n        archive.on('error', reject)\r\n\r\n        // pipe archive data to the file\r\n        archive.pipe(output)\r\n      })\r\n    }\r\n  }\r\n\r\n  file(filePath, internalPath) {\r\n    this.archive.file(filePath, { name: internalPath })\r\n  }\r\n\r\n  directory(directoryPath, internalPath) {\r\n    this.archive.directory(directoryPath, internalPath);\r\n  }\r\n\r\n  append(content, internalPath) {\r\n    this.archive.append(content, { name: internalPath })\r\n  }\r\n\r\n  write() {\r\n    // Maybe `.finalize()` itself returns some `Promise`.\r\n    this.archive.finalize()\r\n    return this.promise || this.archive\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}