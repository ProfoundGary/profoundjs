if(!window.profound)window.profound={};window.profound.ai||(window.profound.ai={});if(!window.pui)window.pui={};
profound.ai.Chat=function(){function h(){if(window.pui&&window.pui.ide&&window.pui.ide.designerId)return true;return false}function p(){var a=Ext.c("centerPanel").f(),d={};if(a.isAIAgent&&a.aiAgent)d.aiAgent=a.aiAgent;if(a.isAIAgent&&a.dataAccess)d.dataAccess=a.dataAccess;Object.assign(d,Object.fromEntries(Object.entries(a.pjsModule).filter(function(c){return typeof c[1]!=="function"})));return d}function l(){function a(){var c=k.lastChild.querySelectorAll(".pai-chart");if(c.length!==0)if(profound.ai.a){for(var e=
0;e<c.length;e++){var f=c[e],m=JSON.parse(f.getAttribute("data-config"));f.removeAttribute("data-config");f.chart=new window.Chart(f.querySelector("canvas"),m);f=f.querySelector("span");f.parentNode.removeChild(f)}k.scrollTop=k.scrollHeight}else{d++;d<20&&setTimeout(a,1E3)}}var d=0;a()}function n(a){function d(){a.read().then(function(m){var j=m.value;if(m.done){b.hideLoader();l()}else{m=c.decode(j).split("\n");for(j=0;j<m.length-1;j++){var g=m[j];if(g){g=JSON.parse(g);if(g.threadId)x=g.threadId;
if(g.status==="error"){b.hideLoader();b.add({message:"Error: "+g.message,type:"error"});return}if(g.status==="calling"){var r=k.lastChild;g=r.innerHTML.replace(y,"")+'<p>Calling <span class="pai-function-name">'+g["function"]+"</span>.</p>";b.add({message:g+y,type:"agent-response",replace:true})}else if(g.status==="calls completed"){r=k.lastChild;var u="<p>";u+=g.count===1?"Call completed.":g.count+" calls completed.";u+="</p>";u=r.innerHTML.replace(y,"")+u;b.add({message:u+y,type:"agent-response",
replace:true})}else{if(g.status==="file")e=e.replace(g.placeholderUrl,g.fileUrl);e+=g.text;if(g.charts){if(!profound.ai.a){var S=window.define;window.define=undefined;profound.ai.b(M,function(){window.define=S;profound.ai.a=true})}f=g.charts}if(f)for(var N in f)e=e.replace(N,'<div class="pai-chart" data-config="'+JSON.stringify(f[N]).replace(/"/g,"&quot;")+'"><span>Loading chart...</span><canvas></canvas></div>');r=e&&typeof window.marked==="function"?window.marked(e+y):e+y;g.status==="citation"&&
H.push(g);for(g=0;g<H.length;g++){u=H[g];r=r.replace(u.citationPlaceholder,u.citationContent)}b.add({message:r,type:"agent-response",replace:true})}}}d()}})}var c=new TextDecoder("utf-8"),e="",f;d()}function C(a){var d=a.status;if(a.threadId)x=a.threadId;if(a.runId)I=a.runId;if(a.modelKey)K=a.modelKey;if(a.message){var c=a.message,e="agent-response";if(a.status==="error"){c="Error: "+c;e="error"}if(a.status==="failed"){c="Failed: "+c;e="error"}if(a.status==="cancelled"){c="Cancelled";e="error"}if(a.status===
"expired"){c="Chat Expired";e="error"}if(a.charts){if(!profound.ai.a){var f=window.define;window.define=undefined;profound.ai.b(M,function(){window.define=f;profound.ai.a=true})}var m=a.charts;for(var j in m)c=c.replace(j,'<div class="pai-chart" data-config="'+JSON.stringify(m[j]).replace(/"/g,"&quot;")+'"><span>Loading chart...</span><canvas></canvas></div>')}b.add({message:c,type:e});a.charts&&l()}d==="queued"||d==="in_progress"?setTimeout(function(){b.poll()},O):b.hideLoader()}function v(){i.value===
""||b.isLoading()?s.classList.remove("pai-send-button-active"):s.classList.add("pai-send-button-active");var a="webkitSpeechRecognition"in window||"SpeechRecognition"in window;if(h()){var d=Ext.c("aiAgentModel").getValue();if(pui.modelVoiceSettings)z=pui.modelVoiceSettings[d];z||(z={})}if(a&&z.enabled===false)a=false;if(a){i.classList.add("pai-with-voice");o.classList.remove("pai-hidden")}else{i.classList.remove("pai-with-voice");o.classList.add("pai-hidden")}}function F(){i.style.height="1px";var a=
i.scrollHeight==0?21:i.scrollHeight;if(a<21)a=21;if(a>100)a=100;k.style.height="calc(100% - "+(a+54+(b.heading?74:0))+"px)";i.style.height=a+"px"}function T(a,d){if(typeof a!=="string")return a;if(a.length!==7)return a;if(a.substring(0,1)!=="#")return a;var c=parseInt(a.substring(1,3),16),e=parseInt(a.substring(3,5),16),f=parseInt(a.substring(5,7),16);c=parseInt(c*(100+d)/100);e=parseInt(e*(100+d)/100);f=parseInt(f*(100+d)/100);c=c<255?c:255;e=e<255?e:255;f=f<255?f:255;return"#"+(c.toString(16).length==
1?"0"+c.toString(16):c.toString(16))+(e.toString(16).length==1?"0"+e.toString(16):e.toString(16))+(f.toString(16).length==1?"0"+f.toString(16):f.toString(16))}var b=this,t=null,k=null,D=null,i=null,s=null,o=null,x=null,I=null,K=null,O=1E3,A=null,J=null,P="Thinking",E="",G="light",B=null,w=false,z={},y='<span class="pai-loader-dot pai-inline-loader"></span>',M="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js",L=null,H=[],Q,q,R=false;this.init=function(a){a||(a={});b.e=a;if(!a.container)a.container=
document.body;if(a.closeButton===undefined)a.closeButton=true;a.closeTitle||(a.closeTitle="Close this conversation");a.sendTitle||(a.sendTitle="Send this message");a.voiceTitle||(a.voiceTitle="Use voice");a.promptPlaceholder||(a.promptPlaceholder="Send a message...");if(a.heading)b.heading=a.heading;if(a.greeting)b.greeting=a.greeting;if(a.agent)b.agent=a.agent;if(a.pollInterval)O=a.pollInterval;if(a.loaderMessage){P=a.loaderMessage;R=true}if(a.server)E=a.server;if(a.data)b.data=a.data;if(a.stream)w=
a.stream;if(typeof a.voice==="object")z=a.voice;if(a.jwt)L=a.jwt;b.dom=document.createElement("div");b.dom.classList.add("pai-chat");b.dom.classList.add("pai-hidden");a.container.appendChild(b.dom);if(a.closeButton){t=document.createElement("div");t.classList.add("pai-close-button");t.title=a.closeTitle;t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
t.addEventListener("click",function(){b.onClose&&b.onClose();h()?b.clear():b.hide()});b.dom.appendChild(t)}k=document.createElement("div");k.classList.add("pai-messages");b.dom.appendChild(k);D=document.createElement("div");D.classList.add("pai-prompt-area");i=document.createElement("textarea");i.classList.add("pai-prompt-box");i.setAttribute("placeholder",a.promptPlaceholder);i.addEventListener("keydown",function(e){if(e.key==="Enter"){e.shiftKey||e.preventDefault();e.stopPropagation();e.shiftKey||
b.send()}v()});i.addEventListener("input",function(){F();v()});D.appendChild(i);o=document.createElement("div");o.classList.add("pai-voice-button");o.title=a.voiceTitle;o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm4.5-3c0 2.5-2 4.5-4.5 4.5S7.5 13.5 7.5 11H6c0 3.07 2.13 5.64 5 6.32V21h2v-3.68c2.87-.68 5-3.25 5-6.32h-1.5z"/></svg>';
D.appendChild(o);if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){Q=window.SpeechRecognition||window.webkitSpeechRecognition;q=new Q;q.continuous=true;q.interimResults=true;o.addEventListener("click",function(){q.lang=z.lang?z.lang:"en-US";o.classList.contains("pai-recording")?q.stop():q.start();o.classList.toggle("pai-recording")});q.onresult=function(e){if(o.classList.contains("pai-recording")){for(var f=[],m=0;m<e.results.length;m++)f.push(e.results[m][0].transcript);i.value=
f.join("");F();i.scrollTop=i.scrollHeight;i.focus();v()}};q.onend=function(){o.classList.remove("pai-recording");i.select();v()};q.onerror=function(e){b.add({message:"Speech recognition error: "+e.error,type:"error"})}}s=document.createElement("div");s.classList.add("pai-send-button");s.title=a.sendTitle;s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>';
s.addEventListener("click",function(){b.send()});D.appendChild(s);b.dom.appendChild(D);A=document.createElement("div");A.classList.add("pai-loader");J=document.createElement("span");J.classList.add("pai-loader-message");A.appendChild(J);for(var d=1;d<=3;d++){var c=document.createElement("div");c.classList.add("pai-loader-dot");A.appendChild(c)}b.clear();a.theme&&b.setTheme(a.theme);a.brandColor&&b.setBrandColor(a.brandColor);v()};this.show=function(){b.dom.classList.remove("pai-hidden");i.focus()};
this.hide=function(){b.dom.classList.add("pai-hidden")};this.add=function(a){var d=a.message,c=document.createElement("div");c.classList.add("pai-message");var e=a.type;e||(e="user-message");c.classList.add("pai-"+e);if(e==="agent-response"){c.classList.add("markdown-body");if(E){d=d.replace(/<img src="\/profound-ai\/image\?file=/g,'<img src="'+E+"/profound-ai/image?file=");d=d.replace(/="\/profound-ai\/file\?file=/g,'="'+E+"/profound-ai/file?file=")}c.innerHTML=d;c.querySelectorAll("a").forEach(function(f){f.addEventListener("click",
function(){pui.skipConfirm=true;setTimeout(function(){pui.skipConfirm=false},250)})});c.querySelectorAll("span.pai-citation").forEach(function(f){function m(){if(j&&!j.matches(":hover")){f.removeChild(j);j=null}}var j,g;f.addEventListener("mouseenter",function(){if(!j)if(f.getAttribute("data-citation")){j=document.createElement("div");j.classList.add("pai-tooltip-content");j.innerHTML=f.getAttribute("data-citation");f.appendChild(j);var r=f.getBoundingClientRect();j.style.left=r.left+"px";j.style.top=
r.top-j.offsetHeight-5+"px";j.addEventListener("mouseenter",function(){clearTimeout(g)});j.addEventListener("mouseleave",function(){m()})}});f.addEventListener("mouseleave",function(){g=setTimeout(m,100)})});if(a.replace)(a=k.lastChild)&&a.classList.contains("pai-agent-response")&&a.parentNode.removeChild(a)}else c.innerText=d;k.appendChild(c);k.scrollTop=k.scrollHeight};this.clear=function(){o.classList.contains("pai-recording")&&q.stop();i.value="";k.innerHTML="";b.greeting&&b.add({message:b.greeting,
type:"greeting"});b.setHeading(b.heading);b.setBrandColor(B);v();I=x=null};this.setTheme=function(a){G=a;G=typeof G!=="string"?"light":G.toLowerCase();G==="dark"?b.dom.classList.add("pai-dark"):b.dom.classList.remove("pai-dark")};this.setBrandColor=function(a){B=a;if(a=b.dom.querySelector(".pai-heading")){a.style.backgroundColor=null;a.style.backgroundImage=null;a.classList.remove("pai-branded")}t&&t.classList.remove("pai-branded");s.style.backgroundColor=null;if(B){var d=T(B,-30);if(a){a.style.backgroundColor=
B;a.style.backgroundImage="linear-gradient(to right, "+B+", "+d+")";a.classList.add("pai-branded")}t&&a&&t.classList.add("pai-branded");s.style.backgroundColor=B}};this.setHeading=function(a){var d=b.dom.querySelector(".pai-heading");if(a){if(d===null){d=document.createElement("div");d.classList.add("pai-heading");b.dom.prepend(d);F()}d.innerText=a}else if(d!==null){d.remove();F()}};this.send=function(){if(i.value!=="")if(!b.isLoading()){if(o.classList.contains("pai-recording")){q.stop();o.classList.toggle("pai-recording")}b.onSend&&
b.onSend(i.value);b.add({message:i.value});H=[];var a={};a.message=i.value;if(x)a.threadId=x;var d="/profound-ai/chat";if(h()){a.agentData=p();a.agentFile=Ext.c("centerPanel").f().title.replace(/\*/g,"").trim();w=pui.streamingModelList.includes(a.agentData.aiAgent.model);d="/ide/profound-ai/chat"}else a.agent=b.agent;var c=b.data;if(typeof c==="function")c=c();if(b.data)a.data=c;i.value="";F();i.focus();b.showLoader();c={"Content-Type":"application/json"};if(w){c.Connection="keep-alive";c["Response-Type"]=
"stream"}if(pui.appJob&&pui.appJob.authToken)c.Authorization="Bearer "+pui.appJob.authToken;else if(L){var e=L;if(typeof e==="function")e=e();c.Authorization="Bearer "+e}fetch(E+d,{method:"POST",headers:c,body:JSON.stringify(a)}).then(function(f){return w?f.body.getReader():f.json()}).then(function(f){w?n(f):C(f)})["catch"](function(f){b.hideLoader();b.add({message:"Error: "+f.message,type:"error"})})}};this.poll=function(){if(!(!x||!I||!K)){var a={};a.threadId=x;a.runId=I;a.modelKey=K;var d="/profound-ai/poll";
if(h())d="/ide/profound-ai/poll";fetch(E+d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(function(c){return c.json()}).then(function(c){C(c)})["catch"](function(c){b.hideLoader();b.add({message:"Error: "+c.message,type:"error"})})}};this.showLoader=function(a){a||(a=b.e.loaderMessage||P);J.innerText=a;if(!b.isLoading()){w?b.add({message:R?a:y,type:"agent-response"}):k.appendChild(A);v();k.scrollTop=k.scrollHeight}};this.hideLoader=function(){if(b.isLoading()){if(w)for(var a=
k.querySelectorAll(".pai-inline-loader"),d=a.length-1;d>=0;d--)a[d].parentNode.removeChild(a[d]);else k.removeChild(A);v()}};this.isLoading=function(){if(w)return k.querySelectorAll(".pai-inline-loader").length>0;return A.parentNode===k};this.destroy=function(){if(b.dom){b.dom.parentNode.removeChild(b.dom);b.dom=null}};this.removeEmbedIcon=function(){profound.ai.removeEmbedIcon()}};
profound.ai.d=function(h){if(!document.querySelector('link[href="'+h+'"]')){var p=document.createElement("link");p.rel="stylesheet";p.href=h;document.head.appendChild(p)}};profound.ai.b=function(h,p){if(document.querySelector('script[src="'+h+'"]'))typeof p==="function"&&p();else{var l=document.createElement("script");l.type="text/javascript";l.src=h;l.onload=function(){typeof p==="function"&&p()};document.head.appendChild(l)}};
profound.ai.startAgent=function(h,p){h||(h={});var l="";if(h.server)l=h.server;if(!p&&h.agent)fetch(l+"/profound-ai/attributes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agent:h.agent})}).then(function(n){return n.json()}).then(function(n){if(n.status==="error")throw Error(n.message);n=n.attributes;for(var C in n)if(h[C]===undefined)h[C]=n[C];profound.ai.startAgent(h,true)})["catch"](function(n){throw Error("Unable to start AI Agent: "+n.message);});else{if(!h.container)h.container=
document.body;h.stream&&profound.ai.b(l+"/marked/marked.min.js");profound.ai.d(l+"/profoundui/proddata/css/markdown.css");profound.ai.d(l+"/profoundui/proddata/css/profoundai.css");profound.ai.agent&&profound.ai.agent.destroy();if(h.embed){if(!profound.ai.embedIcon){profound.ai.embedIcon=document.createElement("div");profound.ai.embedIcon.classList.add("pai-embed-icon");profound.ai.embedIcon.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0z" fill="none"/><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>';
h.container.appendChild(profound.ai.embedIcon)}profound.ai.embedIcon.title=h.embedIconTitle||"Ask AI Agent";l=profound.ai.embedIcon.cloneNode(true);l.addEventListener("click",function(){var n=Object.assign({},h);delete n.embed;profound.ai.startAgent(n)});profound.ai.embedIcon.parentNode.replaceChild(l,profound.ai.embedIcon);profound.ai.embedIcon=l}else{profound.ai.agent=new profound.ai.Chat;profound.ai.agent.init(h);profound.ai.agent.show();return profound.ai.agent}}};
profound.ai.removeEmbedIcon=function(){if(profound.ai.embedIcon){profound.ai.embedIcon.parentNode.removeChild(profound.ai.embedIcon);profound.ai.embedIcon=null}};
